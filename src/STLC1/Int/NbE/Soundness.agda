module STLC1.Int.NbE.Soundness where

open import Prelude hiding ([_])
open import Data.Empty
open import Data.Dec
open import Data.Maybe renaming (rec to recáµ)

open import STLC1.Int.TyTerm
open import STLC1.Int.NbE.CtxExt
open import STLC1.Int.NbE.Subst
open import STLC1.Int.NbE.Norm
open import STLC1.Int.NbE.DefEq
open import STLC1.Int.NbE.Completeness

infix 3 _==^_
infix 3 _==âŠ¤Ì‚_
infix 4 _â“‡_
infix 4 _â“‡Ë¢_

_==^_ : {Î“ : Ctx} {T : Ty} â†’ Î“ âŠ¢ T â†’ Ne^ T â†’ ğ’°
_==^_ {Î“} t ğ“ŠÌ‚ = recáµ âŠ¥ (Î» ğ“Š-ne â†’ t == ğ“Š-ne .fst) (ğ“ŠÌ‚ Î“)

_==âŠ¤Ì‚_ : âˆ€ {Î“ : Ctx} â†’ Î“ âŠ¢ ğŸ™ â†’ âŸ¦ ğŸ™ âŸ§áµ— â†’ ğ’°
_==âŠ¤Ì‚_ {Î“} t  unit   = t == ğ“‰ğ“‰
_==âŠ¤Ì‚_ {Î“} t (ne ğ“ŠÌ‚) = t ==^ ğ“ŠÌ‚

_â“‡_ : âˆ€ {Î“ : Ctx} {T : Ty} â†’ Î“ âŠ¢ T â†’ âŸ¦ T âŸ§áµ— â†’ ğ’°
_â“‡_ {Î“} {T = ğŸ™} t ğ“‹Ì‚ =
    âˆ€ {Î“â€² : Ctx}
    â†’ (Î“â€²â‰¤Î“ : Î“â€² â‰¤ Î“)
    â†’ Î“â€²â‰¤Î“ â‰¤âŠ¢ t ==âŠ¤Ì‚ ğ“‹Ì‚
_â“‡_ {Î“} {S â‡’ T} r f =
    âˆ€ {Î“â€² : Ctx}
    â†’ (Î“â€²â‰¤Î“ : Î“â€² â‰¤ Î“)
    â†’ âˆ€ {s : Î“â€² âŠ¢ S} {a : âŸ¦ S âŸ§áµ—}
    â†’ s â“‡ a
    â†’ (Î“â€²â‰¤Î“ â‰¤âŠ¢ r) Â· s â“‡ f a

==-â“‡-trans : âˆ€ {Î“ : Ctx} {T : Ty} {t tâ€² : Î“ âŠ¢ T} {a : âŸ¦ T âŸ§áµ—}
           â†’ t == tâ€²
           â†’ t â“‡ a
             -------
           â†’ tâ€² â“‡ a
==-â“‡-trans {T = ğŸ™}     {t} {tâ€²} {a = unit} t==tâ€² pf      Î“â€²â‰¤Î“      =
    begin==
  Î“â€²â‰¤Î“ â‰¤âŠ¢ tâ€²
    ==âŸ¨ symâ¼â¼ (congâ¼â¼-sub t==tâ€²) âŸ©
  Î“â€²â‰¤Î“ â‰¤âŠ¢ t
    ==âŸ¨ pf Î“â€²â‰¤Î“ âŸ©
  ğ“‰ğ“‰
    ==âˆ
==-â“‡-trans {T = ğŸ™}     {t} {tâ€²} {a = ne ğ“ŠÌ‚} t==tâ€² pf {Î“â€²} Î“â€²â‰¤Î“     = go (pf Î“â€²â‰¤Î“)
  where
  go : Î“â€²â‰¤Î“ â‰¤âŠ¢ t ==^ ğ“ŠÌ‚ â†’ Î“â€²â‰¤Î“ â‰¤âŠ¢ tâ€² ==^ ğ“ŠÌ‚
  go pfâ€² with ğ“ŠÌ‚ Î“â€²
  ... | just (ğ“Š , _) =
           begin==
         Î“â€²â‰¤Î“ â‰¤âŠ¢ tâ€²
           ==âŸ¨ symâ¼â¼ (congâ¼â¼-sub t==tâ€²) âŸ©
         Î“â€²â‰¤Î“ â‰¤âŠ¢ t
           ==âŸ¨ pfâ€² âŸ©
         ğ“Š
           ==âˆ
==-â“‡-trans {T = S â‡’ T}          {a}        r==râ€² pf      Î“â€²â‰¤Î“ sâ“‡a =
  ==-â“‡-trans rÂ·s==râ€²Â·s rÂ·sâ“‡fa
  where
    rÂ·s==râ€²Â·s = app-compat (congâ¼â¼-sub r==râ€²) reflâ¼â¼
    rÂ·sâ“‡fa = pf Î“â€²â‰¤Î“ sâ“‡a

â“‡-weaken : âˆ€ {Î“â€² Î“ : Ctx} {T : Ty} {Î“â€²â‰¤Î“ : Î“â€² â‰¤ Î“} {t : Î“ âŠ¢ T} {a : âŸ¦ T âŸ§áµ—}
          â†’ t â“‡ a
          â†’ Î“â€²â‰¤Î“ â‰¤âŠ¢ t â“‡ a
â“‡-weaken {T = ğŸ™}     {Î“â€²â‰¤Î“} {t} {a} pf Î“â€³â‰¤Î“â€²                  =
  subst (_==âŠ¤Ì‚ a)
    (sym $ compose-weaken Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“ t)
    (pf (â‰¤-trans Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“))
â“‡-weaken {T = S â‡’ T} {Î“â€²â‰¤Î“} {t} {a} pf Î“â€³â‰¤Î“â€² {s} {a = b} sâ“‡a =
  subst (Î» q â†’ q Â· s â“‡ a b)
    (sym $ compose-weaken Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“ t)
    (pf (â‰¤-trans Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“) sâ“‡a)

mutual
  ==^â†’â“‡â†‘ : âˆ€ {Î“ : Ctx} {T : Ty} {ğ“Š : Î“ âŠ¢ T} {ğ“ŠÌ‚ : Ne^ T}
          â†’ (âˆ€ {Î“â€² : Ctx}
             â†’ (Î“â€²â‰¤Î“ : Î“â€² â‰¤ Î“)
             â†’ Î“â€²â‰¤Î“ â‰¤âŠ¢ ğ“Š ==^ ğ“ŠÌ‚)
            -------------------
          â†’ ğ“Š â“‡ (â†‘áµ€ ğ“ŠÌ‚)
  ==^â†’â“‡â†‘ {T = ğŸ™}              pf                        = pf
  ==^â†’â“‡â†‘ {T = S â‡’ T} {ğ“Š} {ğ“ŠÌ‚} pf {Î“â€²} Î“â€²â‰¤Î“ {s} {a} sâ“‡a =
    ==^â†’â“‡â†‘ {T = T} ğ“ŠÂ·s==ğ“ŠÌ‚Â·â†“Ë¢a
    where
    -- TODO merge
    ğ“ŠÂ·s==ğ“ŠÌ‚Â·â†“Ë¢a : âˆ€ {Î“â€³ : Ctx}
                â†’ (Î“â€³â‰¤Î“â€² : Î“â€³ â‰¤ Î“â€²)
                â†’ Î“â€³â‰¤Î“â€² â‰¤âŠ¢ (Î“â€²â‰¤Î“ â‰¤âŠ¢ ğ“Š) Â· s ==^ ğ“ŠÌ‚ Â·^ (â†“áµ€ a)
    ğ“ŠÂ·s==ğ“ŠÌ‚Â·â†“Ë¢a {Î“â€³} Î“â€³â‰¤Î“â€² = go (pf (â‰¤-trans Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“))
      where
      go : â‰¤-trans Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“ â‰¤âŠ¢ ğ“Š ==^ ğ“ŠÌ‚
         â†’ Î“â€³â‰¤Î“â€² â‰¤âŠ¢ (Î“â€²â‰¤Î“ â‰¤âŠ¢ ğ“Š) Â· s ==^ (ğ“ŠÌ‚ Â·^ â†“áµ€ a)
      go with ğ“ŠÌ‚ Î“â€³
      ... | just (ğ“Šâ€³ , _) = Î» ğ“Š==ğ“Šâ€³ â†’
          begin==
        Î“â€³â‰¤Î“â€² â‰¤âŠ¢ (Î“â€²â‰¤Î“ â‰¤âŠ¢ ğ“Š) Â· s
          ==âŸ¨ app-compat (ï¼â†’== (compose-weaken Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“ ğ“Š)) reflâ¼â¼ âŸ©
        (â‰¤-trans Î“â€³â‰¤Î“â€² Î“â€²â‰¤Î“ â‰¤âŠ¢ ğ“Š) Â· (Î“â€³â‰¤Î“â€² â‰¤âŠ¢ s)
          ==âŸ¨ app-compat ğ“Š==ğ“Šâ€³ reflâ¼â¼ âŸ©
        ğ“Šâ€³ Â· (Î“â€³â‰¤Î“â€² â‰¤âŠ¢ s)
          ==âŸ¨ app-compat reflâ¼â¼ (â“‡â†’==â†“ sâ“‡a Î“â€³â‰¤Î“â€²) âŸ©
        ğ“Šâ€³ Â· â†“áµ€ a Î“â€³ .fst
          ==âˆ
      ... | nothing = id

  xâ“‡â†‘áµ€ğ“Ì‚ : âˆ€ {Î“ : Ctx} {T : Ty}
        â†’ ` here {Î“} {T} â“‡ â†‘áµ€ (ğ“Ì‚ T Î“)
  xâ“‡â†‘áµ€ğ“Ì‚ {T} = ==^â†’â“‡â†‘ x==ğ“Ì‚
    where
    x==ğ“Ì‚ : âˆ€ {Î“ Î“â€² : Ctx}
         â†’ (Î“â€²â‰¤Î“,T : Î“â€² â‰¤ Î“ ï¹ T)
         â†’ Î“â€²â‰¤Î“,T â‰¤âŠ¢ ` here ==^ ğ“Ì‚ T Î“
    x==ğ“Ì‚ {Î“} {Î“â€²} Î“â€²â‰¤Î“,T with Î“â€² â‰¤? (Î“ ï¹ T)
    ... | yes prf = ï¼â†’== (ap (Î» q â†’ ` Ï-â‰¤ q T here) (is-prop-Î² (â‰¤-is-prop Î“â€² (Î“ ï¹ T)) Î“â€²â‰¤Î“,T prf))
    ... | no ctra = ctra Î“â€²â‰¤Î“,T

  â“‡â†’==â†“ : âˆ€ {Î“â€² Î“ : Ctx} {T : Ty} {t : Î“ âŠ¢ T} {a : âŸ¦ T âŸ§áµ—}
        â†’ t â“‡ a
          ----------------------------
        â†’ (Î“â€²â‰¤Î“ : Î“â€² â‰¤ Î“)
        â†’ Î“â€²â‰¤Î“ â‰¤âŠ¢ t == â†“áµ€ a Î“â€² .fst
  â“‡â†’==â†“      {T = ğŸ™}         {a = unit} pf      = pf
  â“‡â†’==â†“ {Î“â€²} {T = ğŸ™}     {t} {a = ne x} pf Î“â€²â‰¤Î“ = go (pf Î“â€²â‰¤Î“)
    where
    go : Î“â€²â‰¤Î“ â‰¤âŠ¢ t ==^ x â†’ Î“â€²â‰¤Î“ â‰¤âŠ¢ t == â†“áµ€ (ne x) Î“â€² .fst
    go with x Î“â€²
    ... | just tm = id
    ... | nothing = Î» e â†’ absurd e
  â“‡â†’==â†“ {Î“â€²} {T = S â‡’ T} {t} {a = f}    pf Î“â€²â‰¤Î“ =
      begin==
    Î“â€²â‰¤Î“ â‰¤âŠ¢ t
      ==âŸ¨ Î· âŸ©
    Æ› (S â†¥âŠ¢ Î“â€²â‰¤Î“ â‰¤âŠ¢ t) Â· ` here
      ==âŸ¨ abs-compat go âŸ©
    â†“áµ€ f Î“â€² .fst
      ==âˆ
     where
     go : (S â†¥âŠ¢ Î“â€²â‰¤Î“ â‰¤âŠ¢ t) Â· ` here == â†“áµ€ (f (â†‘áµ€ (ğ“Ì‚ S Î“â€²))) (Î“â€² ï¹ S) .fst
     go = begin==
        (S â†¥âŠ¢ Î“â€²â‰¤Î“ â‰¤âŠ¢ t) Â· ` here
          ==âŸ¨ app-compat (ï¼â†’== (  sub-sub {Ï„ = â†¥} {weaken Î“â€²â‰¤Î“} {t}
                                âˆ™ sym [id]-identity))
                         reflâ¼â¼ âŸ©
        (â‰¤-ext Î“â€²â‰¤Î“ â‰¤âŠ¢ t) [ idË¢ ] Â· ` here
          ==âŸ¨ app-compat
                (ï¼â†’== (sym (ap (Î» q â†’ (â‰¤-ext Î“â€²â‰¤Î“ â‰¤âŠ¢ t) [ q ]) weaken-id)))
                (ï¼â†’== (sym (ap (Î» q â†’ q S here) weaken-id))) âŸ©
        â‰¤-idâ° â‰¤âŠ¢ (â‰¤-ext Î“â€²â‰¤Î“ â‰¤âŠ¢ t) Â· ` here
          ==âŸ¨ â“‡â†’==â†“ (pf (â‰¤-ext Î“â€²â‰¤Î“) (xâ“‡â†‘áµ€ğ“Ì‚ {Î“â€²} {S}))
                    â‰¤-idâ° âŸ©
        â†“áµ€ (f (â†‘áµ€ (ğ“Ì‚ S Î“â€²))) (Î“â€² ï¹ S) .fst
          ==âˆ

_â“‡Ë¢_ : âˆ€ {Î“ Î” : Ctx} â†’ Sub Î“ Î” â†’ âŸ¦ Î” âŸ§á¶œ â†’ ğ’°
_â“‡Ë¢_ {Î” = Î”} Ïƒ Î´ = âˆ€ {T : Ty} â†’ (x : Î” âˆ‹ T) â†’ Ïƒ T x â“‡ env-lookup x Î´

â“‡Ë¢-weaken : âˆ€ {Î“â€² Î“ Î” : Ctx} {Î“â€²â‰¤Î“ : Î“â€² â‰¤ Î“} {Ïƒ : Sub Î“ Î”} {Î´ : âŸ¦ Î” âŸ§á¶œ}
           â†’ Ïƒ â“‡Ë¢ Î´
           â†’ Ïƒ âˆ˜Ë¢ (weaken Î“â€²â‰¤Î“) â“‡Ë¢ Î´
â“‡Ë¢-weaken {Î“â€²â‰¤Î“ = Î“â€²â‰¤Î“} Ïƒâ“‡Î´ x = â“‡-weaken {Î“â€²â‰¤Î“ = Î“â€²â‰¤Î“} (Ïƒâ“‡Î´ x)

_âŠ¨_ : âˆ€ {T : Ty} â†’ (Î” : Ctx) â†’ Î” âŠ¢ T â†’ ğ’°
_âŠ¨_ {T} Î” t =
  âˆ€ {Î“ : Ctx} {Ïƒ : Sub Î“ Î”} {Î´ : âŸ¦ Î” âŸ§á¶œ}
  â†’ Ïƒ â“‡Ë¢ Î´
    -------
  â†’ t [ Ïƒ ] â“‡ âŸ¦âŠ¢ t âŸ§ Î´

fundamental-lemma : âˆ€ {Î” : Ctx} {T : Ty} {t : Î” âŠ¢ T}
                  â†’ Î” âŠ¨ t
fundamental-lemma                 {t = ğ“‰ğ“‰}            Ïƒâ“‡Î´      _                = reflâ¼â¼
fundamental-lemma                 {t = ` x}           Ïƒâ“‡Î´                       = Ïƒâ“‡Î´ x
fundamental-lemma {Î”} {T = S â‡’ T} {t = Æ› t}   {Ïƒ} {Î´} Ïƒâ“‡Î´ {Î“â€²} Î“â€²â‰¤Î“ {s} {a} sâ“‡a =
  ==-â“‡-trans (symâ¼â¼ Î²) t[exts-Ïƒ][s/x]â“‡âŸ¦tâŸ§âŸ¨Î´,aâŸ©
  where

  t[exts-Ïƒ] : Î“â€² ï¹ S âŠ¢ T
  t[exts-Ïƒ] = t [ exts Ïƒ ] [ exts (weaken Î“â€²â‰¤Î“) ]

  Ïƒâˆ·s : Sub Î“â€² (Î” ï¹ S)
  Ïƒâˆ·s = exts Ïƒ âˆ˜Ë¢ exts (weaken Î“â€²â‰¤Î“) âˆ˜Ë¢ (idË¢ âˆ·Ë¢ s)

  subst-lemmaâ‚ : âˆ€ {U : Ty} {x : Î” âˆ‹ U} â†’ (Ïƒ âˆ˜Ë¢ weaken Î“â€²â‰¤Î“) U x ï¼ Ïƒâˆ·s U (there x)
  subst-lemmaâ‚ {U} {x} =
    (Ïƒ âˆ˜Ë¢ weaken Î“â€²â‰¤Î“) U x
      ï¼âŸ¨âŸ©
    (Ïƒ âˆ˜Ë¢ â†¥ âˆ˜Ë¢ (weaken Î“â€²â‰¤Î“ âˆ·Ë¢ s)) U x
      ï¼âŸ¨ ap (Î» q â†’ q U x) (sym $ sub-assoc {Ïƒ = Ïƒ} {â†¥} {weaken Î“â€²â‰¤Î“ âˆ·Ë¢ s}) âŸ©
    ((Ïƒ âˆ˜Ë¢ â†¥) âˆ˜Ë¢ (weaken Î“â€²â‰¤Î“ âˆ·Ë¢ s)) U x
      ï¼âŸ¨âŸ©
    ((â†¥ âˆ˜Ë¢ ((Ïƒ âˆ˜Ë¢ â†¥) âˆ·Ë¢ ` here)) âˆ˜Ë¢ (weaken Î“â€²â‰¤Î“ âˆ·Ë¢ s)) U x
      ï¼âŸ¨âŸ©
    (â†¥ âˆ˜Ë¢ ((Ïƒ âˆ˜Ë¢ â†¥) âˆ·Ë¢ ` here) âˆ˜Ë¢ (weaken Î“â€²â‰¤Î“ âˆ·Ë¢ s)) U x
      ï¼âŸ¨ ap (Î» q â†’ q U x) (sym $ cong-seq {Ïƒ = â†¥} refl (cong-seq {Ïƒ = exts Ïƒ} exts-cons-shift refl)) âŸ©
    (â†¥ âˆ˜Ë¢ exts Ïƒ âˆ˜Ë¢ (weaken Î“â€²â‰¤Î“ âˆ·Ë¢ s)) U x
      ï¼âŸ¨ ap (Î» q â†’ q U x) (sym $ cong-seq {Ïƒ = â†¥ âˆ˜Ë¢ exts Ïƒ} refl subst-zero-exts-cons) âŸ©
    (â†¥ âˆ˜Ë¢ exts Ïƒ âˆ˜Ë¢ (exts (weaken Î“â€²â‰¤Î“) âˆ˜Ë¢ (idË¢ âˆ·Ë¢ s))) U x
      ï¼âŸ¨âŸ©
    Ïƒâˆ·s U (there x)
      âˆ

  subst-lemmaâ‚‚ : t[exts-Ïƒ] [ s ]â‚€ ï¼ t [ Ïƒâˆ·s ]
  subst-lemmaâ‚‚ =   sub-sub {Ï„ = idË¢ âˆ·Ë¢ s} {exts (weaken Î“â€²â‰¤Î“)} {t [ exts Ïƒ ]}
                 âˆ™ sub-sub {Ï„ = exts (weaken Î“â€²â‰¤Î“) âˆ˜Ë¢ (idË¢ âˆ·Ë¢ s)} {exts Ïƒ} {t}

  Ïƒâˆ·sâ“‡âŸ¨Î´,aâŸ© : Ïƒâˆ·s â“‡Ë¢ (Î´ , a)
  Ïƒâˆ·sâ“‡âŸ¨Î´,aâŸ©  here             = sâ“‡a
  Ïƒâˆ·sâ“‡âŸ¨Î´,aâŸ© (there {A = U} x) =
    subst (_â“‡ env-lookup x Î´)
      subst-lemmaâ‚
      (â“‡Ë¢-weaken {Î“â€²â‰¤Î“ = Î“â€²â‰¤Î“} Ïƒâ“‡Î´ x)

  t[exts-Ïƒ][s/x]â“‡âŸ¦tâŸ§âŸ¨Î´,aâŸ© : t[exts-Ïƒ] [ s ]â‚€ â“‡ âŸ¦âŠ¢ t âŸ§ (Î´ , a)
  t[exts-Ïƒ][s/x]â“‡âŸ¦tâŸ§âŸ¨Î´,aâŸ© =
    subst (_â“‡ âŸ¦âŠ¢ t âŸ§ (Î´ , a))
      (sym subst-lemmaâ‚‚)
      (fundamental-lemma {t = t} Ïƒâˆ·sâ“‡âŸ¨Î´,aâŸ©)

fundamental-lemma                 {t = r Â· s} {Ïƒ} {Î´} Ïƒâ“‡Î´                       =
  let Î“âŠ¨r = fundamental-lemma {t = r} Ïƒâ“‡Î´
      Î“âŠ¨s = fundamental-lemma {t = s} Ïƒâ“‡Î´
    in
  subst ((Î» q â†’ q Â· s [ Ïƒ ] â“‡ âŸ¦âŠ¢ r âŸ§ Î´ (âŸ¦âŠ¢ s âŸ§ Î´)))
    (ap (Î» q â†’ (r [ Ïƒ ]) [ q ]) weaken-id âˆ™ [id]-identity {t = r [ Ïƒ ]})
    (Î“âŠ¨r (â‰¤-id refl) Î“âŠ¨s)

idâ“‡â†‘Î“ : âˆ€ {Î“ : Ctx}
       â†’ idË¢ â“‡Ë¢ (â†‘á¶œ Î“)
idâ“‡â†‘Î“           here     = xâ“‡â†‘áµ€ğ“Ì‚
idâ“‡â†‘Î“ {Î“ ï¹ T} (there x) =
  subst (Î» q â†’ ` x [ q ] â“‡ env-lookup x (â†‘á¶œ Î“))
        weaken-ext
        (â“‡-weaken {Î“â€²â‰¤Î“ = â‰¤-ext {T = T} â‰¤-idâ°} {t = ` x} (idâ“‡â†‘Î“ {Î“} x))

nf-== : âˆ€ {Î“ : Ctx} {T : Ty} {t : Î“ âŠ¢ T}
      â†’ t == nf t
nf-== {Î“} {T} {t} =
  let tâ“‡âŸ¦tâŸ§â†‘Î“ = fundamental-lemma {t = t} (idâ“‡â†‘Î“ {Î“})
      t==â†“áµ€âŸ¦tâŸ§â†‘Î“ = â“‡â†’==â†“ tâ“‡âŸ¦tâŸ§â†‘Î“ â‰¤-idâ°
    in
  transâ¼â¼
    (ï¼â†’== (  sym ([id]-identity {t = t})
            âˆ™ sym ([id]-identity {t = t [ idË¢ ]})
            âˆ™ ap (Î» q â†’ (t [ idË¢ ]) [ q ]) (sym weaken-id)))
    t==â†“áµ€âŸ¦tâŸ§â†‘Î“

-- aka stability
nf-preserves-meaning : âˆ€ {Î“ : Ctx} {T : Ty} {t : Î“ âŠ¢ T} {Î³ : âŸ¦ Î“ âŸ§á¶œ}
                     â†’ âŸ¦âŠ¢ t âŸ§ Î³ ï¼ âŸ¦âŠ¢ nf t âŸ§ Î³
nf-preserves-meaning {t = t} = ==â†’âŸ¦ï¼âŸ§ (nf-== {t = t})

nf-idempotent : âˆ€ {Î“ : Ctx} {T : Ty} {t : Î“ âŠ¢ T}
              â†’ nf t ï¼ nf (nf t)
nf-idempotent {t = t} = completeness (nf-== {t = t})

soundness : âˆ€ {Î“ : Ctx} {T : Ty} {t : Î“ âŠ¢ T} {Î³ : âŸ¦ Î“ âŸ§á¶œ }
          â†’ (âŸ¦âŠ¢ t âŸ§ Î³ ï¼ âŸ¦âŠ¢ nf t âŸ§ Î³) Ã— (nf t ï¼ nf (nf t))
soundness {t = t} = nf-preserves-meaning {t = t} , nf-idempotent {t = t}
