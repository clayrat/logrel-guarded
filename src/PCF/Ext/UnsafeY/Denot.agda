{-# OPTIONS --guarded #-}
module PCF.Ext.UnsafeY.Denot where

open import Prelude
open import Data.Empty
open import Data.Nat

open import Later
open import Interlude
open import Guarded.Partial
open import PCF.Ext.TyTerm
open import PCF.Ext.TyDeriv

private variable
  Î“ Î” : Ctx
  T : Ty

-- Denotation of types
ğ’¯âŸ¦_âŸ§ : Ty â†’ ğ’°
ğ’¯âŸ¦ ğ“ âŸ§    = Part â„•
ğ’¯âŸ¦ S â‡’ T âŸ§ = ğ’¯âŸ¦ S âŸ§ â†’ ğ’¯âŸ¦ T âŸ§

Î¸ : â–¹Alg (ğ’¯âŸ¦ T âŸ§)
Î¸ {T = ğ“} xâ–¹     = later xâ–¹
Î¸ {S â‡’ T}  tfâ–¹ ts = Î¸ (tfâ–¹ âŠ› next ts)

Î´ : ğ’¯âŸ¦ T âŸ§ â†’ ğ’¯âŸ¦ T âŸ§
Î´ = Î¸ âˆ˜ next

^-body : âˆ€ {A}
       â†’ (A â†’ ğ’¯âŸ¦ T âŸ§)
       â†’ â–¹ (Part A â†’ ğ’¯âŸ¦ T âŸ§)
       â†’ Part A â†’ ğ’¯âŸ¦ T âŸ§
^-body f f^â–¹ (now x)    = f x
^-body f f^â–¹ (later pâ–¹) = Î¸ (f^â–¹ âŠ› pâ–¹)

_^ : âˆ€ {A}
   â†’ (A â†’ ğ’¯âŸ¦ T âŸ§)
   â†’ Part A â†’ ğ’¯âŸ¦ T âŸ§
(f ^) = fix (^-body f)

-- Denotation of contexts
ğ’âŸ¦_âŸ§ : Ctx â†’ ğ’°
ğ’âŸ¦ Î“ âŸ§ = âˆ€ T x â†’ Î“ âˆ‹ x â¦‚ T â†’ ğ’¯âŸ¦ T âŸ§

ğ’âˆ… : ğ’âŸ¦ âˆ… âŸ§
ğ’âˆ… T x i = absurd (âˆ…-empty i)

-- Extending denoted contexts
_ï¼†_ : âˆ€ {i}
     â†’ ğ’âŸ¦ Î“ âŸ§ â†’ ğ’¯âŸ¦ T âŸ§ â†’ ğ’âŸ¦ Î“ , i â¦‚ T âŸ§
(_ ï¼† a) _ _ (here ei et) = subst ğ’¯âŸ¦_âŸ§ (sym et) a
(Ï ï¼† _) T x (there ne i) = Ï T x i

-- Denotation of terms
ifz : ğ’¯âŸ¦ T âŸ§ â†’ ğ’¯âŸ¦ T âŸ§ â†’ â„• â†’ ğ’¯âŸ¦ T âŸ§
ifz x y  zero   = x
ifz x y (suc n) = y

ifz^ : ğ’¯âŸ¦ T âŸ§ â†’ ğ’¯âŸ¦ T âŸ§ â†’ ğ’¯âŸ¦ ğ“ âŸ§ â†’ ğ’¯âŸ¦ T âŸ§
ifz^ x y = (ifz x y) ^

â„°âŸ¦_âŸ§ : âˆ€ {t}
     â†’ Î“ âŠ¢ t â¦‚ T â†’ ğ’âŸ¦ Î“ âŸ§ â†’ ğ’¯âŸ¦ T âŸ§
â„°âŸ¦ âŠ¢` i âŸ§          Î³ = Î³ _ _ i
â„°âŸ¦ âŠ¢Æ› e âŠ¢t âŸ§       Î³ = Î» ta â†’ â„°âŸ¦ âŠ¢t âŸ§ (Î³ ï¼† ta)
â„°âŸ¦ âŠ¢r âŠ¢Â· âŠ¢s âŸ§     Î³ = â„°âŸ¦ âŠ¢r âŸ§ Î³ (â„°âŸ¦ âŠ¢s âŸ§ Î³)
â„°âŸ¦ âŠ¢Y âŠ¢t âŸ§        Î³ = fix $ Î¸ âˆ˜ â–¹map (â„°âŸ¦ âŠ¢t âŸ§ Î³)
â„°âŸ¦ âŠ¢ï¼ƒ {n} âŸ§        Î³ = now n
â„°âŸ¦ âŠ¢ğ“ˆ âŠ¢t âŸ§         Î³ = mapáµ– suc (â„°âŸ¦ âŠ¢t âŸ§ Î³)
â„°âŸ¦ âŠ¢ğ“… âŠ¢t âŸ§         Î³ = mapáµ– pred (â„°âŸ¦ âŠ¢t âŸ§ Î³)
â„°âŸ¦ âŠ¢?â° âŠ¢r âŠ¢s âŠ¢t âŸ§ Î³ = ifz^ (â„°âŸ¦ âŠ¢s âŸ§ Î³) (â„°âŸ¦ âŠ¢t âŸ§ Î³) (â„°âŸ¦ âŠ¢r âŸ§ Î³)

-- 2.15

Y-Î´ : âˆ€ {t}
    â†’ (âŠ¢t : Î“ âŠ¢ t â¦‚ T â‡’ T)
    â†’ â„°âŸ¦ âŠ¢Y âŠ¢t âŸ§ ï¼ Î´ âˆ˜ â„°âŸ¦ âŠ¢t âŠ¢Â· (âŠ¢Y âŠ¢t) âŸ§
Y-Î´ âŠ¢t = fun-ext Î» Î³ â†’ fix-path (Î» taâ–¹ â†’ Î¸ (â–¹map (â„°âŸ¦ âŠ¢t âŸ§ Î³) taâ–¹))

-- 2.16

ifz-Î´ : âˆ€ {L Lâ€² M N Î³}
       â†’ (âŠ¢L  : Î“ âŠ¢ L  â¦‚ ğ“)
       â†’ (âŠ¢Lâ€² : Î“ âŠ¢ Lâ€² â¦‚ ğ“)
       â†’ (âŠ¢M : Î“ âŠ¢ M â¦‚ T)
       â†’ (âŠ¢N : Î“ âŠ¢ N â¦‚ T)
       â†’ (â„°âŸ¦ âŠ¢L âŸ§ Î³ ï¼ Î´ (â„°âŸ¦ âŠ¢Lâ€² âŸ§ Î³))
       â†’ â„°âŸ¦ âŠ¢?â° âŠ¢L âŠ¢M âŠ¢N âŸ§ Î³ ï¼ Î´ (â„°âŸ¦ âŠ¢?â° âŠ¢Lâ€² âŠ¢M âŠ¢N âŸ§ Î³)
ifz-Î´ {Î³} âŠ¢L âŠ¢Lâ€² âŠ¢M âŠ¢N eq =
  (â„°âŸ¦ âŠ¢?â° âŠ¢L âŠ¢M âŠ¢N âŸ§ Î³)
    ï¼âŸ¨âŸ©
  ifz^ (â„°âŸ¦ âŠ¢M âŸ§ Î³) (â„°âŸ¦ âŠ¢N âŸ§ Î³) (â„°âŸ¦ âŠ¢L âŸ§ Î³)
    ï¼âŸ¨ ap (ifz^ (â„°âŸ¦ âŠ¢M âŸ§ Î³) (â„°âŸ¦ âŠ¢N âŸ§ Î³)) eq âŸ©
  ifz^ (â„°âŸ¦ âŠ¢M âŸ§ Î³) (â„°âŸ¦ âŠ¢N âŸ§ Î³) (Î´ (â„°âŸ¦ âŠ¢Lâ€² âŸ§ Î³))
    ï¼âŸ¨âŸ©
  Î¸ (dfix (^-body (ifz (â„°âŸ¦ âŠ¢M âŸ§ Î³) (â„°âŸ¦ âŠ¢N âŸ§ Î³))) âŠ› next (â„°âŸ¦ âŠ¢Lâ€² âŸ§ Î³))
    ï¼âŸ¨ ap (Î» q â†’ Î¸ (q âŠ› next ((â„°âŸ¦ âŠ¢Lâ€² âŸ§ Î³)))) (pfix (^-body (ifz (â„°âŸ¦ âŠ¢M âŸ§ Î³) (â„°âŸ¦ âŠ¢N âŸ§ Î³)))) âŸ©
  Î¸ (next (ifz^ (â„°âŸ¦ âŠ¢M âŸ§ Î³) (â„°âŸ¦ âŠ¢N âŸ§ Î³)) âŠ› next (â„°âŸ¦ âŠ¢Lâ€² âŸ§ Î³))
    ï¼âŸ¨âŸ©
  (Î´ (â„°âŸ¦ âŠ¢?â° âŠ¢Lâ€² âŠ¢M âŠ¢N âŸ§ Î³))
    âˆ
