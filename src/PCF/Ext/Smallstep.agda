{-# OPTIONS --guarded #-}
module PCF.Ext.Smallstep where

open import Prelude
open import Data.Empty
open import Data.Nat hiding (_Â·_)
open import Data.String

open import Later
open import Interlude
open import PCF.Ext.Term
open import PCF.Ext.Subst

infix  1 begin_
infixr 2 _â€”â†’âŸ¨_âŸ©_
infix  2 _â€”â† â°_
infix  3 _âˆáµ£
infix  4 _â€”â†’â…_â†_

-- Step-indexed Small-Step Operational Semantics

data Step : ğ’° where
  sâ° sÂ¹ : Step

sâ†’â„• : Step â†’ â„•
sâ†’â„• sâ° = 0
sâ†’â„• sÂ¹ = 1

data _â€”â†’â…_â†_ : Term â†’ Step â†’ Term â†’ ğ’° where
  Î²-Æ›  : âˆ€ {x M N}
         ---------------------------------
       â†’ (Æ› x â‡’ M) Â· N â€”â†’â… sâ° â† M [ x := N ]

  ï¼¹   : âˆ€ {M}
        -------------------
      â†’ Y M â€”â†’â… sÂ¹ â† M Â· Y M

  Î²-ğ“ˆ  : âˆ€ {n}
         --------------------------
       â†’ ğ“ˆ (ï¼ƒ n) â€”â†’â… sâ° â† ï¼ƒ (suc n)

  Î²-ğ“…â° : --------------------
         ğ“… (ï¼ƒ 0) â€”â†’â… sâ° â† ï¼ƒ 0

  Î²-ğ“…Ë¢ : âˆ€ {n}
         --------------------------
       â†’ ğ“… (ï¼ƒ (suc n)) â€”â†’â… sâ° â† ï¼ƒ n

  Î²-?â° : âˆ€ {M N}
        -------------------
      â†’ ?â° (ï¼ƒ 0) â†‘ M â†“ N â€”â†’â… sâ° â† M

  Î²-?Ë¢ : âˆ€ {M N n}
        -------------------
      â†’ ?â° (ï¼ƒ (suc n)) â†‘ M â†“ N â€”â†’â… sâ° â† N

  Î¾-Â· : âˆ€ {M Mâ€² k N}
      â†’ M â€”â†’â… k â† Mâ€²
        -------------------
      â†’ M Â· N â€”â†’â… k â† Mâ€² Â· N

  Î¾-ğ“ˆ : âˆ€ {M Mâ€² k}
      â†’ M â€”â†’â… k â† Mâ€²
        -------------------
      â†’ ğ“ˆ M â€”â†’â… k â† ğ“ˆ Mâ€²

  Î¾-ğ“… : âˆ€ {M Mâ€² k}
      â†’ M â€”â†’â… k â† Mâ€²
        -------------------
      â†’ ğ“… M â€”â†’â… k â† ğ“… Mâ€²

  Î¾-? : âˆ€ {L Lâ€² M N k}
      â†’ L â€”â†’â… k â† Lâ€²
        -------------------
      â†’ ?â° L â†‘ M â†“ N â€”â†’â… k â† ?â° Lâ€² â†‘ M â†“ N

-- 2.1
step-det : âˆ€ M k N kâ€² Nâ€²
         â†’ M â€”â†’â… k  â† N
         â†’ M â€”â†’â… kâ€² â† Nâ€²
         â†’ (k ï¼ kâ€²) Ã— (N ï¼ Nâ€²)
step-det .((Æ› x â‡’ M) Â· N)       .sâ° .(M [ x := N ]) .sâ° .(M [ x := N ])  (Î²-Æ› {x} {M} {N})               Î²-Æ›               = refl , refl
step-det .(Y _)                 .sÂ¹ .(_ Â· Y _)      .sÂ¹ .(_ Â· Y _)        ï¼¹                             ï¼¹                = refl , refl
step-det .(ğ“ˆ (ï¼ƒ _))            .sâ° .(ï¼ƒ _)          .sâ° .(ï¼ƒ _)           Î²-ğ“ˆ                           Î²-ğ“ˆ               = refl , refl
step-det .(ğ“… (ï¼ƒ 0))            .sâ° .(ï¼ƒ 0)          .sâ° .(ï¼ƒ 0)           Î²-ğ“…â°                          Î²-ğ“…â°              = refl , refl
step-det .(ğ“… (ï¼ƒ suc _))        .sâ° .(ï¼ƒ _)          .sâ° .(ï¼ƒ _)           Î²-ğ“…Ë¢                          Î²-ğ“…Ë¢              = refl , refl
step-det .(?â° ï¼ƒ 0 â†‘ N â†“ _)     .sâ°   N              .sâ° .N                Î²-?â°                          Î²-?â°              = refl , refl
step-det .(?â° ï¼ƒ suc _ â†‘ _ â†“ N) .sâ°   N              .sâ° .N                Î²-?Ë¢                          Î²-?Ë¢              = refl , refl
step-det .(M Â· N)                k .(Mâ‚ Â· N)          kâ€² .(Mâ‚‚ Â· N)       (Î¾-Â· {M} {Mâ€² = Mâ‚} {N} sâ‚)     (Î¾-Â· {Mâ€² = Mâ‚‚} sâ‚‚) =
  let kï¼kâ€² , Mï¼Mâ€² = step-det M k Mâ‚ kâ€² Mâ‚‚ sâ‚ sâ‚‚ in
  kï¼kâ€² , ap (_Â· N) Mï¼Mâ€²
step-det .(ğ“ˆ M)                  k .(ğ“ˆ Mâ‚)             kâ€² .(ğ“ˆ Mâ‚‚)         (Î¾-ğ“ˆ {M} {Mâ€² = Mâ‚} sâ‚)         (Î¾-ğ“ˆ {Mâ€² = Mâ‚‚} sâ‚‚) =
  let kï¼kâ€² , Mï¼Mâ€² = step-det M k Mâ‚ kâ€² Mâ‚‚ sâ‚ sâ‚‚ in
  kï¼kâ€² , ap ğ“ˆ Mï¼Mâ€²
step-det .(ğ“… M)                  k .(ğ“… Mâ‚)            kâ€² .(ğ“… Mâ‚‚)         (Î¾-ğ“… {M} {Mâ€² = Mâ‚} sâ‚)         (Î¾-ğ“… {Mâ€² = Mâ‚‚} sâ‚‚) =
  let kï¼kâ€² , Mï¼Mâ€² = step-det M k Mâ‚ kâ€² Mâ‚‚ sâ‚ sâ‚‚ in
  kï¼kâ€² , ap ğ“… Mï¼Mâ€²
step-det .(?â° L â†‘ M â†“ N)         k .(?â° Lâ‚ â†‘ M â†“ N)   kâ€² .(?â° Lâ‚‚ â†‘ M â†“ N) (Î¾-? {L} {Lâ€² = Lâ‚} {M} {N} sâ‚) (Î¾-? {Lâ€² = Lâ‚‚} sâ‚‚) =
  let kï¼kâ€² , Lï¼Lâ€² = step-det L k Lâ‚ kâ€² Lâ‚‚ sâ‚ sâ‚‚ in
  kï¼kâ€² , ap (Î» q â†’ ?â° q â†‘ M â†“ N) Lï¼Lâ€²

-- step RTC on 0

data _â€”â† â°_ : Term â†’ Term â†’ ğ’° where
  _âˆáµ£ : âˆ€ M
      ---------
    â†’ M â€”â† â° M

  _â€”â†’âŸ¨_âŸ©_ : âˆ€ L {M N}
    â†’ L â€”â†’â… sâ° â† M
    â†’ M â€”â† â° N
      ---------
    â†’ L â€”â† â° N

begin_ : âˆ€ {M N}
  â†’ M â€”â† â° N
    ------
  â†’ M â€”â† â° N
begin Mâ€”â† N = Mâ€”â† N

-- lifting
^â€”â† â° : âˆ€ {L M} â†’ L â€”â†’â… sâ° â† M â†’ L â€”â† â° M
^â€”â† â° {L} {M} LM = L â€”â†’âŸ¨ LM âŸ© M âˆáµ£

-- concatenating
_â€”â† â°âˆ˜_ : âˆ€ {L M N} â†’ L â€”â† â° M â†’ M â€”â† â° N â†’ L â€”â† â° N
(_ âˆáµ£)            â€”â† â°âˆ˜ LN = LN
(Lâ‚€ â€”â†’âŸ¨ Lâ‚€L âŸ© LM) â€”â† â°âˆ˜ MN = Lâ‚€ â€”â†’âŸ¨ Lâ‚€L âŸ© (LM â€”â† â°âˆ˜ MN)

-- appending
_â€”â† â°+_ : âˆ€ {L M N} â†’ L â€”â† â° M â†’ M â€”â†’â… sâ° â† N â†’ L â€”â† â° N
LM â€”â† â°+ MN = LM â€”â† â°âˆ˜ (^â€”â† â° MN)

-- congruences
â€”â† â°-Â· : âˆ€ {M Mâ€² N}
       â†’ M â€”â† â° Mâ€²
       â†’ (M Â· N) â€”â† â° (Mâ€² Â· N)
â€”â† â°-Â· {M} {.M} {N} (.M âˆáµ£)         = M Â· N âˆáµ£
â€”â† â°-Â· {M} {Mâ€²} {N} (.M â€”â†’âŸ¨ S âŸ© MS) = M Â· N â€”â†’âŸ¨ Î¾-Â· S âŸ© â€”â† â°-Â· MS

â€”â† â°-ğ“ˆ : âˆ€ {M Mâ€²}
       â†’ M â€”â† â° Mâ€²
       â†’ (ğ“ˆ M) â€”â† â° (ğ“ˆ Mâ€²)
â€”â† â°-ğ“ˆ {M} {.M} (.M âˆáµ£)         = ğ“ˆ M âˆáµ£
â€”â† â°-ğ“ˆ {M} {Mâ€²} (.M â€”â†’âŸ¨ S âŸ© MS) = ğ“ˆ M â€”â†’âŸ¨ Î¾-ğ“ˆ S âŸ© â€”â† â°-ğ“ˆ MS

â€”â† â°-ğ“… : âˆ€ {M Mâ€²}
       â†’ M â€”â† â° Mâ€²
       â†’ (ğ“… M) â€”â† â° (ğ“… Mâ€²)
â€”â† â°-ğ“… {M} {.M} (.M âˆáµ£)         = ğ“… M âˆáµ£
â€”â† â°-ğ“… {M} {Mâ€²} (.M â€”â†’âŸ¨ S âŸ© MS) = ğ“… M â€”â†’âŸ¨ Î¾-ğ“… S âŸ© â€”â† â°-ğ“… MS

â€”â† â°-? : âˆ€ {L Lâ€² M N}
       â†’ L â€”â† â° Lâ€²
       â†’ (?â° L â†‘ M â†“ N) â€”â† â° (?â° Lâ€² â†‘ M â†“ N)
â€”â† â°-? {L} {.L} {M} {N} (.L âˆáµ£)         = ?â° L â†‘ M â†“ N âˆáµ£
â€”â† â°-? {L} {Lâ€²} {M} {N} (.L â€”â†’âŸ¨ S âŸ© MS) = ?â° L â†‘ M â†“ N â€”â†’âŸ¨ Î¾-? S âŸ© â€”â† â°-? MS

-- step RTC over arbitrary steps w/ predicate
_=â‡’â…_â†_ : Term â†’ â„• â†’ (Term â†’ ğ’°) â†’ ğ’°
M =â‡’â… 0     â† Q = Î£[ N ê‰ Term ] (M â€”â† â° N) Ã— (Q N)
M =â‡’â… suc k â† Q = Î£[ Mâ€² ê‰ Term ] (Î£[ Mâ€³ ê‰ Term ] (M â€”â† â° Mâ€²) Ã— (Mâ€² â€”â†’â… sÂ¹ â† Mâ€³) Ã— â–¹ (Mâ€³ =â‡’â… k â† Q))

-- step RTC over arbitrary steps
_=â‡’â…_â†áµ—_ : Term â†’ â„• â†’ Term â†’ ğ’°
M =â‡’â… k â†áµ— N = M =â‡’â… k â† (_ï¼ N)
